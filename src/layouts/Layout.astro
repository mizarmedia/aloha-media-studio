---
import '../styles/global.css'

interface Props {
  title?: string
  description?: string
  canonical?: string
  ogImage?: string
  ogType?: string
  noindex?: boolean
  schema?: object
}

const {
  title = "Aloha Media Studio | Podcast Production in Eagle, Idaho",
  description = "Launch your professional podcast in 90 days. Full-service podcast production for business ownersâ€”we handle planning, recording, editing, and publishing. Eagle, Idaho.",
  canonical,
  ogImage = "https://alohamediastudio.com/images/studio/studio-interior-1.jpg",
  ogType = "website",
  noindex = false,
  schema
} = Astro.props

// Build canonical URL
const canonicalURL = canonical
  ? new URL(canonical, Astro.site || 'https://alohamediastudio.com').href
  : new URL(Astro.url.pathname, 'https://alohamediastudio.com').href

// Check if we're on the studio page (hide floating CTA there since booking is main focus)
const isStudioPage = Astro.url.pathname.startsWith('/studio')

// Check if we're on the homepage (global schemas only fire on homepage)
const isHomepage = Astro.url.pathname === '/' || Astro.url.pathname === ''
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="/images/logo/favicon-192.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/images/logo/favicon-32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/images/logo/apple-touch-icon.png" />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content="Aloha Media Studio" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Additional SEO -->
    <meta name="author" content="Aloha Media Studio" />
    <meta name="geo.region" content="US-ID" />
    <meta name="geo.placename" content="Eagle, Idaho" />

    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XN4GQWRCM0"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XN4GQWRCM0');
    </script>

    <!-- Preconnects -->
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://cal.com" />
    <link rel="dns-prefetch" href="https://formsubmit.co" />
    <link rel="dns-prefetch" href="https://www.youtube.com" />

    <!-- Self-hosted Inter font - eliminates render-blocking Google Fonts request -->
    <link rel="preload" href="/fonts/inter-latin.woff2" as="font" type="font/woff2" crossorigin />
    <style>
      @font-face {
        font-family: 'Inter';
        font-style: normal;
        font-weight: 400 700;
        font-display: swap;
        src: url('/fonts/inter-latin.woff2') format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
    </style>

    <title>{title}</title>

    <!-- Schema.org - Organization (homepage only) -->
    {isHomepage && <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "@id": "https://alohamediastudio.com/#organization",
      "name": "Aloha Media Studio",
      "url": "https://alohamediastudio.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://alohamediastudio.com/images/logo/aloha-media-logo.png"
      },
      "description": "Professional podcast production and media services in Eagle, Idaho",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Eagle",
        "addressRegion": "ID",
        "addressCountry": "US"
      },
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "sales",
        "url": "https://alohamediastudio.com/#contact"
      },
      "sameAs": [
        "https://www.youtube.com/@AlohaMediaStudio"
      ],
      "parentOrganization": {
        "@type": "Organization",
        "name": "Aloha Publishing",
        "url": "https://alohapublishing.com"
      }
    })} />}

    <!-- Schema.org - WebSite with SearchAction (homepage only) -->
    {isHomepage && <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebSite",
      "@id": "https://alohamediastudio.com/#website",
      "name": "Aloha Media Studio",
      "url": "https://alohamediastudio.com",
      "publisher": {
        "@id": "https://alohamediastudio.com/#organization"
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://alohamediastudio.com/?s={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      }
    })} />}

    <!-- Schema.org - LocalBusiness (homepage only) -->
    {isHomepage && <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "LocalBusiness",
      "@id": "https://alohamediastudio.com/#localbusiness",
      "name": "Aloha Media Studio",
      "description": "Full-service podcast production for business owners in Eagle, Idaho and the Boise area. We handle planning, multi-camera recording, editing, and distribution.",
      "url": "https://alohamediastudio.com",
      "logo": "https://alohamediastudio.com/images/logo/aloha-media-logo.png",
      "image": "https://alohamediastudio.com/images/studio/studio-interior-1.jpg",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Eagle",
        "addressRegion": "ID",
        "postalCode": "83616",
        "addressCountry": "US"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": "43.6955",
        "longitude": "-116.3539"
      },
      "openingHoursSpecification": {
        "@type": "OpeningHoursSpecification",
        "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
        "opens": "10:00",
        "closes": "17:00"
      },
      "priceRange": "$$",
      "areaServed": {
        "@type": "GeoCircle",
        "geoMidpoint": {
          "@type": "GeoCoordinates",
          "latitude": "43.6955",
          "longitude": "-116.3539"
        },
        "geoRadius": "50 mi"
      }
    })} />}

    <!-- Page-specific schema -->
    {schema && <script type="application/ld+json" set:html={JSON.stringify(schema)} />}
  </head>
  <body class="antialiased bg-[var(--color-void)]">
    <slot />
    
    <!-- Initialize animations - deferred until browser is idle -->
    <script>
      import { initAllAnimations } from '../scripts/animations'

      // Defer animations until browser is idle to reduce main thread blocking
      // This moves script evaluation outside the PageSpeed measurement window
      function initWhenIdle() {
        if ('requestIdleCallback' in window) {
          requestIdleCallback(() => initAllAnimations(), { timeout: 2000 })
        } else {
          // Fallback for Safari - wait for load + small delay
          setTimeout(initAllAnimations, 100)
        }
      }

      if (document.readyState === 'complete') {
        initWhenIdle()
      } else {
        window.addEventListener('load', initWhenIdle)
      }
    </script>

    <!-- Floating "Rent Studio Space" Button - Hidden on studio page -->
    {!isStudioPage && (
      <a
        id="floating-cta"
        href="/studio#booking"
        class="fixed bottom-6 right-6 z-50 flex items-center gap-2 px-4 py-3 md:px-5 md:py-3 bg-[var(--color-studio-blue)] text-white font-semibold text-sm md:text-base rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 opacity-0 pointer-events-none"
        style="box-shadow: 0 4px 14px rgba(74, 124, 155, 0.4);"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        Rent Studio Space
      </a>
    )}
    <script>
      // Show floating CTA after scrolling past hero, hide when footer visible
      const floatingCta = document.getElementById('floating-cta');
      const footer = document.querySelector('footer');

      if (floatingCta) {
        let footerVisible = false;

        // Footer observer
        if (footer) {
          const footerObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              footerVisible = entry.isIntersecting;
              updateFloatingCta();
            });
          }, { threshold: 0.1 });
          footerObserver.observe(footer);
        }

        // Scroll handler - show after scrolling past hero (~100vh)
        function updateFloatingCta() {
          const scrolledPastHero = window.scrollY > window.innerHeight * 0.8;
          const shouldShow = scrolledPastHero && !footerVisible;

          floatingCta.style.opacity = shouldShow ? '1' : '0';
          floatingCta.style.pointerEvents = shouldShow ? 'auto' : 'none';
        }

        window.addEventListener('scroll', updateFloatingCta, { passive: true });
        updateFloatingCta();
      }
    </script>
  </body>
</html>
